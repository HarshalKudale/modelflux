name: Build Android (EAS Cloud)

on:
    workflow_dispatch:

permissions:
    contents: write

env:
    EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    OTA_SERVER_URL: ${{ secrets.OTA_SERVER_URL }}
    RELEASE_SECRET: ${{ secrets.RELEASE_SECRET }}

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "yarn"

            - name: Enable Corepack & Yarn
              run: |
                  corepack enable
                  corepack prepare yarn@1.22.22 --activate

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Install EAS CLI
              run: npm install -g eas-cli

            - name: Get Current Runtime Version
              id: runtime
              run: |
                  RUNTIME_VERSION=$(node -p "require('./app.json').expo.version")
                  echo "current=$RUNTIME_VERSION" >> $GITHUB_OUTPUT
                  echo "Current runtime version: $RUNTIME_VERSION"

            - name: Build Android APK (EAS Cloud)
              run: eas build --platform android --profile production-apk --non-interactive

            - name: Download Build Artifact
              run: |
                  # Get the latest build URL
                  BUILD_URL=$(eas build:list --platform android --limit 1 --json --non-interactive | node -p "JSON.parse(require('fs').readFileSync(0, 'utf8'))[0].artifacts?.buildUrl")
                  if [ "$BUILD_URL" != "null" ] && [ -n "$BUILD_URL" ]; then
                    echo "Downloading build from: $BUILD_URL"
                    curl -L -o app-prod.apk "$BUILD_URL"
                  else
                    echo "No build artifact URL found"
                    exit 1
                  fi

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: android-apk
                  path: app-prod.apk
                  retention-days: 14

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.runtime.outputs.current }}
                  name: "Release v${{ steps.runtime.outputs.current }}"
                  body: "Android production build v${{ steps.runtime.outputs.current }}"
                  files: app-prod.apk

            - name: Bump Runtime Version
              if: ${{ github.event.inputs.bump_runtime == 'true' }}
              run: |
                  CURRENT="${{ steps.runtime.outputs.current }}"
                  # Parse semver and bump patch
                  IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
                  NEW_PATCH=$((PATCH + 1))
                  NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
                  echo "Bumping version from $CURRENT to $NEW_VERSION"

                  # Update app.json
                  node -e "
                  const fs = require('fs');
                  const appJson = JSON.parse(fs.readFileSync('app.json', 'utf8'));
                  appJson.expo.version = '$NEW_VERSION';
                  fs.writeFileSync('app.json', JSON.stringify(appJson, null, 2) + '\n');
                  "

                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

            - name: Commit Version Bump
              if: ${{ github.event.inputs.bump_runtime == 'true' }}
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add app.json
                  git commit -m "chore: bump version to $(node -p "require('./app.json').expo.version")"
                  git push

            - name: Notify OTA Server of Runtime Bump
              if: ${{ github.event.inputs.bump_runtime == 'true' }}
              run: |
                  node << 'EOF'
                  const https = require('https');
                  const http = require('http');

                  const newVersion = process.argv[2] || require('./app.json').expo.version;
                  const serverUrl = new URL(process.env.OTA_SERVER_URL + '/api/runtime/bump');
                  const isHttps = serverUrl.protocol === 'https:';
                  const client = isHttps ? https : http;

                  const payload = {
                    runtimeVersion: newVersion,
                    bumpedAt: new Date().toISOString(),
                    commitHash: '${{ github.sha }}'
                  };

                  const options = {
                    hostname: serverUrl.hostname,
                    port: serverUrl.port || (isHttps ? 443 : 80),
                    path: serverUrl.pathname,
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${process.env.RELEASE_SECRET}`
                    }
                  };

                  const req = client.request(options, (res) => {
                    let body = '';
                    res.on('data', chunk => body += chunk);
                    res.on('end', () => {
                      console.log('Response:', res.statusCode, body);
                      if (res.statusCode >= 400) {
                        console.error('Failed to notify OTA server');
                        process.exit(1);
                      }
                    });
                  });

                  req.on('error', (e) => {
                    console.error('Error:', e);
                    process.exit(1);
                  });

                  req.write(JSON.stringify(payload));
                  req.end();
                  EOF
